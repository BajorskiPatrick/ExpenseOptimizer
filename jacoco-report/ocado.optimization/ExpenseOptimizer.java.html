<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExpenseOptimizer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ExpenseOptimizer</a> &gt; <a href="index.source.html" class="el_package">ocado.optimization</a> &gt; <span class="el_source">ExpenseOptimizer.java</span></div><h1>ExpenseOptimizer.java</h1><pre class="source lang-java linenums">package ocado.optimization;

import ocado.model.Order;
import ocado.model.PaymentMethod;
import ocado.utils.OptimizerUtils;

import java.util.*;

/**
 * Klasa odpowiedzialna za optymalizację wydatków poprzez wybór najlepszych metod płatności dla zamówień.
 */
public class ExpenseOptimizer {
    /** Lista zamówień do optymalizacji */
    private final List&lt;Order&gt; orders;

    /** Mapa dostępnych metod płatności (z wyjątkiem metody punktowej) */
    private final Map&lt;String, PaymentMethod&gt; payments;

    /** Metoda płatności punktowej (PUNKTY) */
    private final PaymentMethod pointsMethod;

    /** Obiekt {@link OptimizerUtils} dostarczający niezbędnych metod */
<span class="fc" id="L23">    private final OptimizerUtils utils = new OptimizerUtils();</span>

    /**
     * Konstruktor klasy ExpenseOptimizer.
     *
     * @param orders lista zamówień
     * @param payments mapa metod płatności
     * @param pointsMethod metoda płatności punktowej
     */
<span class="fc" id="L32">    public ExpenseOptimizer(List&lt;Order&gt; orders, Map&lt;String, PaymentMethod&gt; payments, PaymentMethod pointsMethod) {</span>
<span class="fc" id="L33">        this.orders = orders;</span>
<span class="fc" id="L34">        this.payments = payments;</span>
<span class="fc" id="L35">        this.pointsMethod = pointsMethod;</span>
<span class="fc" id="L36">    }</span>

    /**
     * Główna metoda optymalizująca płatności dla zamówień.
     *
     * @return true, jeśli optymalizacja zakończyła się sukcesem, false w przeciwnym wypadku
     * @throws IllegalArgumentException wyjątek rzucany z jednej z metod {@link OptimizerUtils#pay(PaymentMethod, Order)},
     * {@link OptimizerUtils#pay(PaymentMethod, double)}, {@link #spentRemainingPoints()} i przekazywany dalej
     */
    public boolean optimize() throws IllegalArgumentException {
<span class="fc" id="L46">        orders.sort(Comparator.comparing(Order::getValue).reversed());</span>

<span class="fc" id="L48">        boolean wasEverythingPaid = true;</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">        for (Order order : orders) {</span>
<span class="fc" id="L50">            double bestPromotion = 0;</span>
<span class="fc" id="L51">            List&lt;PaymentMethod&gt; bestMethods = new ArrayList&lt;&gt;();</span>

            // Znajdujemy maksymalną procentową zniżkę z tych, które mogą nam dać metody z listy promotions.
<span class="fc bfc" id="L54" title="All 2 branches covered.">            for (String s : order.getPromotions()) {</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">                if (!payments.containsKey(s)) {</span>
<span class="nc" id="L56">                    continue;</span>
                }
<span class="fc" id="L58">                PaymentMethod pm = payments.get(s);</span>
<span class="fc" id="L59">                pm.decrementOrdersAmount();</span>
<span class="pc bpc" id="L60" title="1 of 4 branches missed.">                if (pm.getLimit() &gt;= order.getValue() &amp;&amp; pm.getDiscount() &gt; bestPromotion) {</span>
<span class="fc" id="L61">                    bestPromotion = pm.getDiscount();</span>
                }
<span class="fc" id="L63">            }</span>

            // Jeśli płatność wszystkiego punktami jest możliwa, to wybieramy tę opcję. Jeśli nie, to rozpatrujemy
            // wszystkie metody, których zniżka równa najlepszej zniżce.
<span class="fc bfc" id="L67" title="All 2 branches covered.">            if (pointsMethod.getLimit() &gt;= order.getValue()</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">                    &amp;&amp; pointsMethod.getDiscount() &gt;= bestPromotion) {</span>
<span class="fc" id="L69">                bestMethods.add(pointsMethod);</span>
<span class="fc" id="L70">                bestPromotion = pointsMethod.getDiscount();</span>
            }
<span class="fc bfc" id="L72" title="All 2 branches covered.">            else if (bestPromotion &gt; 0) {</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">                for (String s : order.getPromotions()) {</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">                    if (!payments.containsKey(s)) {</span>
<span class="nc" id="L75">                        continue;</span>
                    }
<span class="fc bfc" id="L77" title="All 2 branches covered.">                    if (payments.get(s).getDiscount() == bestPromotion) {</span>
<span class="fc" id="L78">                        bestMethods.add(payments.get(s));</span>
                    }
<span class="fc" id="L80">                }</span>
            }

<span class="fc bfc" id="L83" title="All 2 branches covered.">            if (bestPromotion &gt; 10) {</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">                if (bestMethods.size() == 1) {</span>
                    // Brak remisu lub remis PUNKTY-KARTA.
<span class="fc" id="L86">                    utils.pay(bestMethods.getFirst(), order);</span>
<span class="fc" id="L87">                    order.usePaymentsMethod(bestMethods.getFirst().getId(), order.getValue());</span>
                }
                else {
                    // Remis KARTA-KARTA.
<span class="nc" id="L91">                    PaymentMethod pm = utils.findOptimalCard(bestMethods);</span>
<span class="nc" id="L92">                    utils.pay(pm, order);</span>
<span class="nc" id="L93">                    order.usePaymentsMethod(pm.getId(), order.getValue());</span>
<span class="nc" id="L94">                }</span>
            }
            else {
<span class="fc" id="L97">                double toPayByPoints = order.getValue() * 0.1; // Początkowo 10% zamówienia.</span>
<span class="fc" id="L98">                double toPayByCard = order.getValue() - toPayByPoints * 2; // Bo 10% z punktów, plus drugie tyle rabatu.</span>
                PaymentMethod pm;

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">                if (toPayByPoints &lt;= pointsMethod.getLimit()) {</span>
                    // Stosujemy płatność PUNKTY_10 i chcemy opłacić z punktów tylko 10% (resztę punktów zachować na później).
                    // Resztę zamówienia chcemy opłacić &quot;najgorszą&quot; możliwą kartą.
<span class="fc" id="L104">                    double finalToPayByCard = toPayByCard;</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">                    pm = utils.findBestCardToPayRest(payments.values().stream().filter(p -&gt; p.getLimit() &gt;= finalToPayByCard).toList());</span>

<span class="pc bpc" id="L107" title="1 of 2 branches missed.">                    if (pm == null) {</span>
                        // Nie znaleźliśmy karty z limitem, który pozwoli opłacić punktami jedynie 10% - zatem szukamy
                        // karty z maksymalnym limitem &lt;= niż aktualne &quot;toPayByCard&quot; i uzupełniamy punktami.
<span class="nc" id="L110">                        List&lt;PaymentMethod&gt; maxLimitCards = utils.findWithMaxLimit(payments.values().stream().toList());</span>
<span class="nc" id="L111">                        pm = utils.findBestCardToPayRest(maxLimitCards);</span>

<span class="nc bnc" id="L113" title="All 4 branches missed.">                        if (pm != null &amp;&amp; order.getValue() - pm.getLimit() &lt;= pointsMethod.getLimit()) {</span>
                            // Wystarcza punktów na uzupełnienie do wybranej karty, więc płacimy.
<span class="nc" id="L115">                            toPayByCard = pm.getLimit();</span>
<span class="nc" id="L116">                            toPayByPoints = order.getValue() * 0.9 - toPayByCard;</span>
                        }
                        else {
                            // Doszliśmy do momentu, w którym nie jesteśmy w stanie dobrać żadnej metody płatności
                            // do zamówienia -&gt; prawdopodobnie do tego przykładu zastosowana heurystyka się nie sprawdza,
                            // więc kończymy optymalizację :(.
<span class="nc" id="L122">                            wasEverythingPaid = false;</span>
<span class="nc" id="L123">                            break;</span>
                        }
                    }
<span class="fc" id="L126">                    utils.pay(pointsMethod, toPayByPoints);</span>
<span class="fc" id="L127">                    utils.pay(pm, toPayByCard);</span>
<span class="fc" id="L128">                    order.usePaymentsMethod(&quot;PUNKTY_10&quot;, toPayByPoints);</span>
<span class="fc" id="L129">                    order.usePaymentsMethod(pm.getId(), toPayByCard);</span>
<span class="fc" id="L130">                }</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                else if (bestMethods.size() == 1) {</span>
                    // Nie damy rady zapłacić punktami i jest brak remisu.
<span class="nc" id="L133">                    utils.pay(bestMethods.getFirst(), order);</span>
<span class="nc" id="L134">                    order.usePaymentsMethod(bestMethods.getFirst().getId(), order.getValue());</span>
                }
<span class="nc bnc" id="L136" title="All 2 branches missed.">                else if (bestMethods.size() &gt; 1) {</span>
                    // Nie damy rady zapłacić punktami i jest remis KARTA-KARTA.
<span class="nc" id="L138">                    pm = utils.findOptimalCard(bestMethods);</span>
<span class="nc" id="L139">                    utils.pay(pm, order);</span>
<span class="nc" id="L140">                    order.usePaymentsMethod(pm.getId(), order.getValue());</span>
                }
                else {
                    // Nie ma żadnej promocyjnej opcji płatności i PUNKTY_10 również nie mogą być zastosowane.
                    // Szukamy karty do opłacenia reszty (całego zamówienia) i ją stosujemy.
<span class="nc bnc" id="L145" title="All 2 branches missed.">                    pm = utils.findBestCardToPayRest(payments.values().stream().filter(p -&gt; p.getLimit() &gt;= order.getValue()).toList());</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                    if (pm == null) {</span>
                        // Również dochodzimy do momentu, w którym nie jesteśmy w stanie dobrać żadnej metody płatności
                        // do zamówienia, więc kończymy optymalizację :(.
<span class="nc" id="L149">                        wasEverythingPaid = false;</span>
<span class="nc" id="L150">                        break;</span>
                    }
<span class="nc" id="L152">                    utils.pay(pm, order);</span>
<span class="nc" id="L153">                    order.usePaymentsMethod(pm.getId(), order.getValue());</span>
                }
            }
<span class="fc" id="L156">        }</span>

        // Skończyliśmy główną pętlę algorytmu. Jeśli nie udało się w niej opłacić wszystkich zamówień lub wyczerpaliśmy
        // punkty -&gt; po prostu zwracamy wynik działania algorytmu.
<span class="pc bpc" id="L160" title="2 of 4 branches missed.">        if (!wasEverythingPaid || pointsMethod.getLimit() == 0) {</span>
<span class="nc" id="L161">            return wasEverythingPaid;</span>
        }

        // W innym wypadku będziemy iterować od ostatniego zamówienia i &quot;poprawiać&quot; wynik algorytmu, poprzez wydanie
        // pozostałych punktów na zamówienia opłacone metodą PUNKTY_10 -&gt; będziemy &quot;oddawać&quot; określoną kwotę na kartę
        // użytą do uzupełnienia tego zamówienia i &quot;dopłacać&quot; tę kwotę punktami, aż do momentu, gdy pozbędziemy się
        // wszystkich punktów -&gt; w duchu ograniczenia minimalizacji płatności kartą.
<span class="fc" id="L168">        spentRemainingPoints();</span>

<span class="fc" id="L170">        return true;</span>
    }

    /**
     * Metoda wydająca pozostałe punkty na zamówienia opłacone metodą PUNKTY_10.
     * @throws IllegalArgumentException wyjątek rzucany z {@link PaymentMethod#getMoneyBack(double)} i przekazywany dalej
     */
    private void spentRemainingPoints() throws IllegalArgumentException {
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        for (Order order : orders.reversed()) {</span>
            // Zamówienie może mieć maksymalnie 2 opcje płatności -&gt; PUNKTY_10 + KARTA.
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">            if (order.getUsedPaymentsMethods().size() != 2) {</span>
<span class="nc" id="L181">                continue;</span>
            }
<span class="fc" id="L183">            String usedCard = &quot;&quot;;</span>
<span class="fc" id="L184">            double spentAmount = 0;</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">            for (Map.Entry&lt;String, Double&gt; entry : order.getUsedPaymentsMethods().entrySet()) {</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">                if (!entry.getKey().equals(&quot;PUNKTY_10&quot;)) {</span>
<span class="fc" id="L187">                    usedCard = entry.getKey();</span>
<span class="fc" id="L188">                    spentAmount = entry.getValue();</span>
<span class="fc" id="L189">                    break;</span>
                }
<span class="fc" id="L191">            }</span>

<span class="pc bpc" id="L193" title="1 of 2 branches missed.">            if (spentAmount &gt;= pointsMethod.getLimit()) {</span>
                // W tej sytuacji wydaliśmy już wszystkie punkty, więc kończymy.
<span class="fc" id="L195">                payments.get(usedCard).getMoneyBack(pointsMethod.getLimit());</span>
<span class="fc" id="L196">                pointsMethod.spend(pointsMethod.getLimit());</span>
<span class="fc" id="L197">                break;</span>
            }
            else {
                // Tutaj wydaliśmy tylko część naszych pozostałych punktów, więc idziemy do kolejnego zamówienia.
<span class="nc" id="L201">                payments.get(usedCard).getMoneyBack(spentAmount);</span>
<span class="nc" id="L202">                pointsMethod.spend(spentAmount);</span>
            }
<span class="nc" id="L204">        }</span>
<span class="fc" id="L205">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>